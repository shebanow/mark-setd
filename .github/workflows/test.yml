name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test-ubuntu:
    name: Test on Ubuntu ${{ matrix.version }}
    runs-on: ${{ matrix.version }}
    strategy:
      fail-fast: false
      matrix:
        version: [ubuntu-latest, ubuntu-22.04, ubuntu-20.04]
        shell: [bash, zsh, sh, dash]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential g++ make
          case "${{ matrix.shell }}" in
            zsh) sudo apt-get install -y zsh ;;
            dash) sudo apt-get install -y dash ;;
            *) true ;;
          esac
      
      - name: Build
        run: |
          make clean
          make all
      
      - name: Install binaries
        run: |
          mkdir -p $HOME/bin
          cp setd $HOME/bin/
          cp mark $HOME/bin/
          chmod +x $HOME/bin/setd $HOME/bin/mark
          echo "$HOME/bin" >> $GITHUB_PATH
      
      - name: Set environment variables
        run: |
          echo "SETD_DIR=$HOME/bin" >> $GITHUB_ENV
          echo "MARK_DIR=$HOME/bin" >> $GITHUB_ENV
      
      - name: Run tests with ${{ matrix.shell }}
        run: |
          cd tests
          case "${{ matrix.shell }}" in
            bash) bash test_bash.sh ;;
            zsh) zsh test_zsh.sh || bash test_zsh.sh ;;
            sh) sh test_sh.sh ;;
            dash) dash test_dash.sh || sh test_dash.sh ;;
          esac

  test-debian:
    name: Test on Debian
    runs-on: ubuntu-latest
    # Debian is similar to Ubuntu, but we can test with different package versions
    strategy:
      fail-fast: false
      matrix:
        shell: [bash, zsh, sh, dash]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential g++ make
          case "${{ matrix.shell }}" in
            zsh) sudo apt-get install -y zsh ;;
            dash) sudo apt-get install -y dash ;;
            *) true ;;
          esac
      
      - name: Build
        run: |
          make clean
          make all
      
      - name: Install binaries
        run: |
          mkdir -p $HOME/bin
          cp setd $HOME/bin/
          cp mark $HOME/bin/
          chmod +x $HOME/bin/setd $HOME/bin/mark
          echo "$HOME/bin" >> $GITHUB_PATH
      
      - name: Set environment variables
        run: |
          echo "SETD_DIR=$HOME/bin" >> $GITHUB_ENV
          echo "MARK_DIR=$HOME/bin" >> $GITHUB_ENV
      
      - name: Run tests with ${{ matrix.shell }}
        run: |
          cd tests
          case "${{ matrix.shell }}" in
            bash) bash test_bash.sh ;;
            zsh) zsh test_zsh.sh || bash test_zsh.sh ;;
            sh) sh test_sh.sh ;;
            dash) dash test_dash.sh || sh test_dash.sh ;;
          esac

  test-macos:
    name: Test on macOS ${{ matrix.version }}
    runs-on: ${{ matrix.version }}
    strategy:
      fail-fast: false
      matrix:
        version: [macos-latest, macos-13, macos-12]
        shell: [bash, zsh, sh, dash]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          brew install bash zsh dash || true
          # Ensure we have make (usually pre-installed)
          which make || brew install make
      
      - name: Build
        run: |
          make clean
          make all
      
      - name: Install binaries
        run: |
          mkdir -p $HOME/bin
          cp setd $HOME/bin/
          cp mark $HOME/bin/
          chmod +x $HOME/bin/setd $HOME/bin/mark
          echo "$HOME/bin" >> $GITHUB_PATH
      
      - name: Set environment variables
        run: |
          echo "SETD_DIR=$HOME/bin" >> $GITHUB_ENV
          echo "MARK_DIR=$HOME/bin" >> $GITHUB_ENV
      
      - name: Run tests with ${{ matrix.shell }}
        run: |
          cd tests
          case "${{ matrix.shell }}" in
            bash) bash test_bash.sh ;;
            zsh) zsh test_zsh.sh || bash test_zsh.sh ;;
            sh) sh test_sh.sh ;;
            dash) dash test_dash.sh || sh test_dash.sh ;;
          esac

  test-windows:
    name: Test on Windows
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        shell: [bash, zsh]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install MSYS2/MinGW
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: mingw-w64-x86_64-gcc mingw-w64-x86_64-make bash
      
      - name: Install zsh (if needed)
        if: matrix.shell == 'zsh'
        shell: msys2 {0}
        run: |
          pacman -S --noconfirm zsh || true
      
      - name: Build
        shell: msys2 {0}
        run: |
          export PATH="/mingw64/bin:$PATH"
          make clean
          make all
      
      - name: Install binaries
        shell: msys2 {0}
        run: |
          mkdir -p $HOME/bin
          if [ -f setd.exe ]; then
            cp setd.exe $HOME/bin/
          else
            cp setd $HOME/bin/
          fi
          if [ -f mark.exe ]; then
            cp mark.exe $HOME/bin/
          else
            cp mark $HOME/bin/
          fi
          chmod +x $HOME/bin/setd $HOME/bin/mark
          echo "$HOME/bin" >> $GITHUB_PATH
      
      - name: Set environment variables
        shell: msys2 {0}
        run: |
          echo "SETD_DIR=$HOME/bin" >> $GITHUB_ENV
          echo "MARK_DIR=$HOME/bin" >> $GITHUB_ENV
      
      - name: Run Windows tests with ${{ matrix.shell }}
        shell: msys2 {0}
        run: |
          cd tests
          if [ "${{ matrix.shell }}" = "bash" ]; then
            bash test_windows.sh
          elif [ "${{ matrix.shell }}" = "zsh" ]; then
            zsh test_windows.sh || bash test_windows.sh
          fi

  test-csh-shells:
    name: Test csh/tcsh on Ubuntu
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shell: [csh, tcsh]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential g++ make
          case "${{ matrix.shell }}" in
            csh) sudo apt-get install -y csh ;;
            tcsh) sudo apt-get install -y tcsh ;;
          esac
      
      - name: Build
        run: |
          make clean
          make all
      
      - name: Install binaries
        run: |
          mkdir -p $HOME/bin
          cp setd $HOME/bin/
          cp mark $HOME/bin/
          chmod +x $HOME/bin/setd $HOME/bin/mark
          echo "$HOME/bin" >> $GITHUB_PATH
      
      - name: Set environment variables
        run: |
          echo "SETD_DIR=$HOME/bin" >> $GITHUB_ENV
          echo "MARK_DIR=$HOME/bin" >> $GITHUB_ENV
      
      - name: Run tests with ${{ matrix.shell }}
        run: |
          cd tests
          case "${{ matrix.shell }}" in
            csh) csh test_csh.sh ;;
            tcsh) tcsh test_tcsh.sh ;;
          esac

  test-ksh:
    name: Test ksh on Ubuntu
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential g++ make ksh
      
      - name: Build
        run: |
          make clean
          make all
      
      - name: Install binaries
        run: |
          mkdir -p $HOME/bin
          cp setd $HOME/bin/
          cp mark $HOME/bin/
          chmod +x $HOME/bin/setd $HOME/bin/mark
          echo "$HOME/bin" >> $GITHUB_PATH
      
      - name: Set environment variables
        run: |
          echo "SETD_DIR=$HOME/bin" >> $GITHUB_ENV
          echo "MARK_DIR=$HOME/bin" >> $GITHUB_ENV
      
      - name: Run ksh tests
        run: |
          cd tests
          ksh test_ksh.sh || bash test_ksh.sh

  test-fish:
    name: Test fish on Ubuntu
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential g++ make fish
      
      - name: Build
        run: |
          make clean
          make all
      
      - name: Install binaries
        run: |
          mkdir -p $HOME/bin
          cp setd $HOME/bin/
          cp mark $HOME/bin/
          chmod +x $HOME/bin/setd $HOME/bin/mark
          echo "$HOME/bin" >> $GITHUB_PATH
      
      - name: Set environment variables
        run: |
          echo "SETD_DIR=$HOME/bin" >> $GITHUB_ENV
          echo "MARK_DIR=$HOME/bin" >> $GITHUB_ENV
      
      - name: Run fish tests
        run: |
          cd tests
          fish test_fish.sh || bash -c 'echo "Fish shell test skipped - may need manual verification"'
